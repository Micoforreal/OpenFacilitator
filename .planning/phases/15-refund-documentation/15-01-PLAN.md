---
phase: 15-refund-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/dashboard/src/app/docs/sdk/refunds/page.mdx
  - apps/dashboard/src/components/docs/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Refund guide is accessible at /docs/sdk/refunds/"
    - "Sidebar navigation includes Refunds entry under SDK section"
    - "reportFailure code examples demonstrate complete usage"
    - "withRefundProtection middleware example shows end-to-end setup"
  artifacts:
    - path: "apps/dashboard/src/app/docs/sdk/refunds/page.mdx"
      provides: "Comprehensive refund documentation page"
      min_lines: 150
    - path: "apps/dashboard/src/components/docs/Sidebar.tsx"
      provides: "Sidebar with refunds navigation entry"
      contains: "href: '/docs/sdk/refunds'"
  key_links:
    - from: "Sidebar.tsx"
      to: "/docs/sdk/refunds"
      via: "navigation array entry"
      pattern: "title:.*Refunds.*href:.*refunds"
---

<objective>
Create comprehensive refund documentation for merchants implementing refund protection.

Purpose: Merchants need clear guidance on using `reportFailure` and `withRefundProtection` to handle service failures after payment settlement.
Output: Single MDX documentation page accessible at `/docs/sdk/refunds/` with sidebar navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-refund-documentation/15-CONTEXT.md
@.planning/phases/15-refund-documentation/15-RESEARCH.md
@apps/dashboard/src/app/docs/sdk/settle/page.mdx
@apps/dashboard/src/components/docs/Sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create refunds documentation page</name>
  <files>apps/dashboard/src/app/docs/sdk/refunds/page.mdx</files>
  <action>
Create MDX documentation page at `apps/dashboard/src/app/docs/sdk/refunds/page.mdx`.

**Page structure (follow pattern from settle/page.mdx):**

1. **Imports and PageHeader**
   - Import Callout component
   - PageHeader with title "Refund Protection" and description about handling service failures

2. **Why Refunds Matter** (brief intro paragraph)
   - x402 payments settle before service delivery
   - If service fails after payment, user deserves refund
   - Refund protection automates this reporting

3. **Prerequisites**
   - Registered server with API key
   - Funded refund wallet on target network(s)
   - Refunds enabled for facilitator

4. **reportFailure** section (DOCS-03)
   - Usage snippet
   - Parameters table (facilitatorUrl, apiKey, originalTxHash, userWallet, amount, asset, network, reason)
   - Response type (ReportFailureResponse)
   - Complete example showing success/error handling
   - Callout: reportFailure returns errors in response, does NOT throw

5. **withRefundProtection** section (DOCS-04)
   - Usage snippet showing wrapper pattern
   - RefundProtectionConfig table (apiKey, facilitatorUrl, shouldReport, onReport, onReportError)
   - PaymentContext type definition
   - createPaymentContext helper usage
   - Complete example showing typical integration flow

6. **Error Handling** section
   - Table of error scenarios (Invalid API key, Inactive server, Refunds disabled, Duplicate claim, No refund wallet)
   - Code example of handling errors

7. **Troubleshooting** section
   - Common issues and solutions in Q&A format

8. **Callouts throughout:**
   - Warning: Partial failure scenario (payment succeeded but service failed)
   - Tip: Network formats accepted (both simple and CAIP-2)
   - Tip: When to use reportFailure vs withRefundProtection

**Code examples must include:**
- Full TypeScript type annotations
- Import statements from @openfacilitator/sdk
- Real asset address for Base USDC: 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913
- Comments explaining key steps

**API details from research:**

reportFailure params:
- facilitatorUrl: string (e.g., "https://api.openfacilitator.io")
- apiKey: string
- originalTxHash: string
- userWallet: string
- amount: string (atomic units, e.g., "1000000" for $1 USDC)
- asset: string (token contract address)
- network: string (e.g., "base", "solana", or CAIP-2)
- reason?: string (optional)

ReportFailureResponse:
- success: boolean
- claimId?: string (present if success)
- error?: string (present if failure)

RefundProtectionConfig:
- apiKey: string
- facilitatorUrl: string
- shouldReport?: (error: Error) => boolean
- onReport?: (claimId: string | undefined, error: Error) => void
- onReportError?: (reportError: Error, originalError: Error) => void

PaymentContext:
- transactionHash: string
- userWallet: string
- amount: string
- asset: string
- network: string
  </action>
  <verify>
1. File exists at apps/dashboard/src/app/docs/sdk/refunds/page.mdx
2. File contains PageHeader component
3. File contains reportFailure examples with all required parameters
4. File contains withRefundProtection examples with config and PaymentContext
5. File contains Callout components for warnings/tips
6. Run: `pnpm --filter=dashboard build` to verify MDX compiles without errors
  </verify>
  <done>
- MDX page exists with all sections (intro, prerequisites, reportFailure, withRefundProtection, error handling, troubleshooting)
- reportFailure code examples show complete parameter usage and response handling (DOCS-03)
- withRefundProtection examples show config, PaymentContext, and createPaymentContext (DOCS-04)
- Page builds successfully with Next.js
  </done>
</task>

<task type="auto">
  <name>Task 2: Add sidebar navigation entry</name>
  <files>apps/dashboard/src/components/docs/Sidebar.tsx</files>
  <action>
Modify `apps/dashboard/src/components/docs/Sidebar.tsx` to add Refunds entry to SDK children array.

**Current SDK children (lines 19-27):**
```typescript
children: [
  { title: 'Installation', href: '/docs/sdk/installation' },
  { title: 'verify()', href: '/docs/sdk/verify' },
  { title: 'settle()', href: '/docs/sdk/settle' },
  { title: 'supported()', href: '/docs/sdk/supported' },
  { title: 'Fee Payer', href: '/docs/sdk/fee-payer' },
  { title: 'Networks', href: '/docs/sdk/networks' },
  { title: 'Errors', href: '/docs/sdk/errors' },
],
```

**Add after Errors entry:**
```typescript
{ title: 'Refunds', href: '/docs/sdk/refunds' },
```

Placement rationale: Refunds is a specialized topic that follows the main SDK methods, so after Errors makes sense. It could also go after settle() since refunds relate to post-settlement handling - use judgment based on logical flow.
  </action>
  <verify>
1. Sidebar.tsx contains `{ title: 'Refunds', href: '/docs/sdk/refunds' }` in SDK children
2. Run: `pnpm --filter=dashboard build` to verify TypeScript compiles
3. Run dev server and verify Refunds appears in sidebar under SDK section
  </verify>
  <done>
- Sidebar.tsx has Refunds entry in SDK children array (DOCS-02)
- Navigation link points to /docs/sdk/refunds
- Dashboard builds without errors
  </done>
</task>

</tasks>

<verification>
1. **Build verification:** `pnpm --filter=dashboard build` completes without errors
2. **Route accessibility:** Dev server shows page at http://localhost:3000/docs/sdk/refunds
3. **Navigation:** Sidebar shows Refunds link under SDK section
4. **Content completeness:** Page contains all required sections (reportFailure, withRefundProtection, error handling, troubleshooting)
5. **Code examples:** Both reportFailure and withRefundProtection have complete, typed examples
</verification>

<success_criteria>
- [ ] Refund guide accessible at `/docs/sdk/refunds/` (DOCS-01)
- [ ] Sidebar navigation includes Refunds entry under SDK section (DOCS-02)
- [ ] `reportFailure` code examples demonstrate complete usage (DOCS-03)
- [ ] `withRefundProtection` middleware example shows end-to-end setup (DOCS-04)
- [ ] Dashboard builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/15-refund-documentation/15-01-SUMMARY.md`
</output>
