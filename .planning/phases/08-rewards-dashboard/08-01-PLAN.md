---
phase: 08-rewards-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/db/volume-aggregation.ts
  - packages/server/src/routes/rewards.ts
  - apps/dashboard/src/lib/api.ts
  - apps/dashboard/src/components/rewards/progress-dashboard.tsx
  - apps/dashboard/src/components/rewards/progress-bar.tsx
  - apps/dashboard/src/components/rewards/reward-estimate.tsx
  - apps/dashboard/src/components/rewards/address-breakdown.tsx
  - apps/dashboard/src/app/rewards/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can see volume vs threshold as progress bar (hero element)"
    - "User can see estimated rewards with ~X $OPEN format"
    - "User can see days remaining in campaign"
    - "User can see per-address volume breakdown"
    - "Progress bar turns green when threshold is met"
    - "Motivational message appears when below threshold"
  artifacts:
    - path: "apps/dashboard/src/components/rewards/progress-dashboard.tsx"
      provides: "Main dashboard layout with hero progress bar"
      min_lines: 80
    - path: "apps/dashboard/src/components/rewards/progress-bar.tsx"
      provides: "Reusable progress bar component"
      min_lines: 20
    - path: "apps/dashboard/src/components/rewards/reward-estimate.tsx"
      provides: "Estimated reward display with multiplier badge"
      min_lines: 30
    - path: "apps/dashboard/src/components/rewards/address-breakdown.tsx"
      provides: "Per-address volume list"
      min_lines: 40
    - path: "packages/server/src/routes/rewards.ts"
      provides: "GET /api/rewards/volume/breakdown endpoint"
      contains: "volume/breakdown"
  key_links:
    - from: "apps/dashboard/src/app/rewards/page.tsx"
      to: "apps/dashboard/src/components/rewards/progress-dashboard.tsx"
      via: "component import and render"
      pattern: "ProgressDashboard"
    - from: "apps/dashboard/src/components/rewards/progress-dashboard.tsx"
      to: "/api/rewards/volume/breakdown"
      via: "fetch via api.getVolumeBreakdown"
      pattern: "getVolumeBreakdown"
    - from: "apps/dashboard/src/components/rewards/progress-bar.tsx"
      to: "green color on threshold met"
      via: "conditional className"
      pattern: "bg-green"
---

<objective>
Create the rewards progress dashboard with hero progress bar, reward estimates, and per-address volume breakdown.

Purpose: Users need visual feedback on their progress toward earning rewards - this motivates continued engagement and helps them understand their standing.

Output: A refactored rewards page with progress bar as hero element, estimated rewards display, days remaining countdown, and per-address volume breakdown.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-rewards-dashboard/08-CONTEXT.md
@.planning/phases/08-rewards-dashboard/08-RESEARCH.md

# Relevant prior phase outputs
@.planning/phases/06-volume-tracking-engine/06-01-SUMMARY.md
@.planning/phases/07-campaign-system/07-02-SUMMARY.md

# Key existing files to reference
@apps/dashboard/src/components/campaigns/campaign-rules.tsx
@apps/dashboard/src/app/rewards/page.tsx
@apps/dashboard/src/lib/api.ts
@packages/server/src/db/volume-aggregation.ts
@packages/server/src/routes/rewards.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add per-address volume breakdown API</name>
  <files>
    packages/server/src/db/volume-aggregation.ts
    packages/server/src/routes/rewards.ts
    apps/dashboard/src/lib/api.ts
  </files>
  <action>
Add a function to get volume breakdown per reward address:

In `packages/server/src/db/volume-aggregation.ts`, add:

```typescript
/**
 * Get per-address volume breakdown for a user
 * Returns each verified address with its individual volume contribution
 */
export function getVolumeBreakdownByUser(
  userId: string,
  campaignId: string
): {
  userId: string;
  campaignId: string;
  totalVolume: string;
  addresses: Array<{
    id: string;
    address: string;
    chain_type: 'solana' | 'evm' | 'facilitator';
    volume: string;
    uniquePayers: number;
  }>;
}
```

Implementation approach:
1. Query volume_snapshots joined with reward_addresses
2. Group by reward_address_id
3. Include facilitator marker addresses (chain_type='facilitator')
4. Sum volumes per address for the campaign

In `packages/server/src/routes/rewards.ts`, add endpoint:
- `GET /volume/breakdown?campaignId=xxx`
- Requires auth (uses req.user.id)
- Returns breakdown per address

In `apps/dashboard/src/lib/api.ts`:
- Add `VolumeBreakdown` type
- Add `getVolumeBreakdown(campaignId: string)` method
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd packages/server && pnpm build
cd apps/dashboard && pnpm build
```
  </verify>
  <done>
API endpoint returns per-address volume breakdown. API client has `getVolumeBreakdown()` method typed correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create progress dashboard components</name>
  <files>
    apps/dashboard/src/components/rewards/progress-bar.tsx
    apps/dashboard/src/components/rewards/reward-estimate.tsx
    apps/dashboard/src/components/rewards/address-breakdown.tsx
    apps/dashboard/src/components/rewards/progress-dashboard.tsx
  </files>
  <action>
Create the dashboard components per CONTEXT.md specifications:

**progress-bar.tsx** - Hero progress bar component:
- Props: `current: string`, `threshold: string`, `className?: string`
- Display format: "$12,450.00 / $50,000 (24.9%)" above the bar
- Horizontal bar that fills left to right
- Default `bg-primary` color, switches to `bg-green-500` when threshold met
- Use existing `formatUSDC()` pattern from campaign-rules.tsx
- Handle edge cases: divide by zero, amounts stored as atomic units (divide by 1e6)

**reward-estimate.tsx** - Estimated reward display:
- Props: `estimatedReward: number`, `metThreshold: boolean`, `hasMultiplier: boolean`, `multiplier: number`
- Label: "Est. Reward:" when threshold met, "If you qualify:" when below
- Format: "~1,234 $OPEN"
- Show 2x Badge when hasMultiplier is true
- Small note: "*based on current volume"

**address-breakdown.tsx** - Per-address volume list:
- Props: `addresses: Array<{id, address, chain_type, volume, uniquePayers}>`, `totalVolume: string`
- Header: "Tracked Addresses"
- Each row shows: chain badge ([S] purple for solana, [E] blue for evm, [F] for facilitator), truncated address, volume amount, percentage of total
- Use existing address truncation pattern from address-card.tsx

**progress-dashboard.tsx** - Main dashboard layout:
- Props: `campaign: Campaign`, `userVolume: string`, `totalPoolVolume: string`, `isFacilitatorOwner: boolean`, `volumeBreakdown: VolumeBreakdown | null`
- Layout structure (top to bottom):
  1. ProgressBar (hero - most prominent)
  2. Motivational message (threshold status - green box if met, amber if not)
  3. RewardEstimate
  4. Days remaining (simple text: "X days remaining", no urgency styling)
  5. AddressBreakdown (if volumeBreakdown provided)
- Extract calculation logic from campaign-rules.tsx (multiplier, share, estimated reward)
- Handle campaign ended state: show "Rewards being calculated..." instead of progress
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/dashboard && pnpm build
```
Components follow existing patterns from campaign-rules.tsx.
  </verify>
  <done>
Four new components created: ProgressBar, RewardEstimate, AddressBreakdown, ProgressDashboard. All handle edge cases (no campaign, ended campaign, division by zero).
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate dashboard into rewards page</name>
  <files>
    apps/dashboard/src/app/rewards/page.tsx
  </files>
  <action>
Update the rewards page to use the new ProgressDashboard:

1. Add query for volume breakdown:
```typescript
const { data: breakdownData } = useQuery({
  queryKey: ['volumeBreakdown', activeCampaign?.campaign?.id],
  queryFn: () => api.getVolumeBreakdown(activeCampaign!.campaign!.id),
  enabled: !!activeCampaign?.campaign?.id,
});
```

2. Replace `CampaignRules` component with `ProgressDashboard`:
- Pass campaign, userVolume, totalPoolVolume, isFacilitatorOwner, volumeBreakdown
- Keep the existing campaign history section unchanged

3. Handle campaign states:
- No campaign: Show "No Active Campaign" message (existing behavior)
- Active campaign: Show ProgressDashboard
- Ended campaign: ProgressDashboard handles this internally (shows "calculating" state)

4. Keep existing elements:
- Header with trophy icon and "Rewards" title
- Admin button linking to /rewards/admin (for admins)
- Campaign History section at bottom

The page should now show:
- Hero progress bar at top
- Threshold status message
- Estimated reward
- Days remaining
- Address breakdown
- Campaign history (unchanged)
  </action>
  <verify>
1. Run dev server and visit /rewards
2. Verify progress bar displays correctly with volume vs threshold
3. Verify threshold message shows (amber when below, green when met)
4. Verify estimated reward shows with correct multiplier badge
5. Verify days remaining shows
6. Verify address breakdown shows tracked addresses with volumes

```bash
cd apps/dashboard && pnpm dev
# Visit http://localhost:3000/rewards
```
  </verify>
  <done>
Rewards page displays ProgressDashboard with hero progress bar, motivational messaging, reward estimates, days remaining, and per-address volume breakdown. Existing campaign history section preserved.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Progress bar displays correctly:**
   - Shows "$X / $Y (Z%)" format
   - Bar fills proportionally
   - Green when threshold met, primary color when below

2. **Motivational messaging works:**
   - Below threshold: "Keep going! $X more to qualify for rewards"
   - At/above threshold: "You've reached the threshold! You're eligible for rewards."

3. **Reward estimate displays:**
   - Shows "~X $OPEN" format
   - Label changes: "Est. Reward:" vs "If you qualify:"
   - 2x badge appears for facilitator owners
   - "*based on current volume" note visible

4. **Days remaining shows:**
   - Simple "X days remaining" text
   - No urgency styling

5. **Address breakdown shows:**
   - Each tracked address with chain badge
   - Volume per address
   - Percentage of total

6. **Edge cases handled:**
   - No active campaign: shows "No Active Campaign" message
   - Campaign ended: shows "Rewards being calculated..." state
   - Zero volume: displays correctly without errors
   - Division by zero: guarded in percentage calculations
</verification>

<success_criteria>
- [ ] GET /api/rewards/volume/breakdown returns per-address volumes
- [ ] Progress bar is the hero element (most prominent on page)
- [ ] Progress bar turns green when threshold is met
- [ ] Estimated reward shows with ~X $OPEN format
- [ ] Days remaining displays without urgency styling
- [ ] Address breakdown shows individual address contributions
- [ ] Motivational messaging encourages users below threshold
- [ ] TypeScript compiles without errors
- [ ] Existing campaign history section preserved
</success_criteria>

<output>
After completion, create `.planning/phases/08-rewards-dashboard/08-01-SUMMARY.md` following the summary template.
</output>
